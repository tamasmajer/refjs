<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TagUI Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
  <div box="App"></div>

  <template box="Calculator">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
      <div class="mb-4">
        <div box="Display"
          class="bg-gray-900 text-white text-right text-3xl font-mono p-4 rounded-lg min-h-[4rem] flex items-center justify-end overflow-hidden">
          0
        </div>
      </div>

      <div class="grid grid-cols-4 gap-3">
        <!-- Row 1: Clear, ±, %, ÷ -->
        <button box="ClearBtn"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          AC
        </button>
        <button box="PlusMinusBtn"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          ±
        </button>
        <button box="PercentBtn"
          class="bg-gray-300 hover:bg-gray-400 text-black font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          %
        </button>
        <button box="DivideBtn"
          class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          ÷
        </button>

        <!-- Row 2: 7, 8, 9, × -->
        <button box="Btn7"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          7
        </button>
        <button box="Btn8"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          8
        </button>
        <button box="Btn9"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          9
        </button>
        <button box="MultiplyBtn"
          class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          ×
        </button>

        <!-- Row 3: 4, 5, 6, - -->
        <button box="Btn4"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          4
        </button>
        <button box="Btn5"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          5
        </button>
        <button box="Btn6"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          6
        </button>
        <button box="SubtractBtn"
          class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          −
        </button>

        <!-- Row 4: 1, 2, 3, + -->
        <button box="Btn1"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          1
        </button>
        <button box="Btn2"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          2
        </button>
        <button box="Btn3"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          3
        </button>
        <button box="AddBtn"
          class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          +
        </button>

        <!-- Row 5: 0 (spans 2), ., = -->
        <button box="Btn0"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors col-span-2 min-h-[4rem]">
          0
        </button>
        <button box="DecimalBtn"
          class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          .
        </button>
        <button box="EqualsBtn"
          class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-6 px-4 text-xl rounded-xl transition-colors min-h-[4rem]">
          =
        </button>
      </div>
    </div>
  </template>

  <script type="module">
    import box from 'https://cdn.jsdelivr.net/gh/tamasmajer/maagic-box/magic-box.min.js'

    // Calculator state
    const display = box('0')
    const previousValue = box(0)
    const operation = box(null)
    const waitingForOperand = box(false)

    // Format display value
    const formatDisplay = (value) => {
      const num = parseFloat(value)
      if (isNaN(num)) return '0'

      // Handle very large or very small numbers
      if (Math.abs(num) >= 1e10 || (Math.abs(num) < 1e-6 && num !== 0)) {
        return num.toExponential(5)
      }

      // Remove unnecessary decimal places
      return num.toString().slice(0, 12)
    }

    // Input a digit
    const inputDigit = (digit) => {
      if (waitingForOperand.box) {
        display.box = String(digit)
        waitingForOperand.box = false
      } else {
        display.box = display.box === '0' ? String(digit) : display.box + digit
      }
    }

    // Input decimal point
    const inputDecimal = () => {
      if (waitingForOperand.box) {
        display.box = '0.'
        waitingForOperand.box = false
      } else if (display.box.indexOf('.') === -1) {
        display.box = display.box + '.'
      }
    }

    // Clear calculator
    const clear = () => {
      display.box = '0'
      previousValue.box = 0
      operation.box = null
      waitingForOperand.box = false
    }

    // Toggle sign
    const toggleSign = () => {
      const value = parseFloat(display.box)
      if (value !== 0) {
        display.box = String(-value)
      }
    }

    // Calculate percentage
    const percentage = () => {
      const value = parseFloat(display.box)
      display.box = String(value / 100)
    }

    // Perform calculation
    const calculate = (firstOperand, secondOperand, operation) => {
      switch (operation) {
        case '+':
          return firstOperand + secondOperand
        case '-':
          return firstOperand - secondOperand
        case '*':
          return firstOperand * secondOperand
        case '/':
          return secondOperand !== 0 ? firstOperand / secondOperand : 0
        default:
          return secondOperand
      }
    }

    // Perform operation
    const performOperation = (nextOperation) => {
      const inputValue = parseFloat(display.box)

      if (previousValue.box === 0) {
        previousValue.box = inputValue
      } else if (operation.box) {
        const currentValue = previousValue.box || 0
        const newValue = calculate(currentValue, inputValue, operation.box)

        display.box = formatDisplay(newValue)
        previousValue.box = newValue
      }

      waitingForOperand.box = true
      operation.box = nextOperation
    }

    // Handle equals
    const handleEquals = () => {
      if (operation.box && !waitingForOperand.box) {
        const inputValue = parseFloat(display.box)
        const currentValue = previousValue.box || 0
        const newValue = calculate(currentValue, inputValue, operation.box)

        display.box = formatDisplay(newValue)
        previousValue.box = 0
        operation.box = null
        waitingForOperand.box = true
      }
    }

    // Keyboard support
    box(document, {
      onkeydown: (e) => {
        e.preventDefault()

        if (e.key >= '0' && e.key <= '9') {
          inputDigit(parseInt(e.key))
        } else if (e.key === '.') {
          inputDecimal()
        } else if (e.key === '+') {
          performOperation('+')
        } else if (e.key === '-') {
          performOperation('-')
        } else if (e.key === '*') {
          performOperation('*')
        } else if (e.key === '/') {
          performOperation('/')
        } else if (e.key === 'Enter' || e.key === '=') {
          handleEquals()
        } else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') {
          clear()
        } else if (e.key === '%') {
          percentage()
        }
      }
    })

    // Render calculator
    box.App(box.Calculator({
      Display: () => display.box,

      // Number buttons
      Btn0: { onclick: () => inputDigit(0) },
      Btn1: { onclick: () => inputDigit(1) },
      Btn2: { onclick: () => inputDigit(2) },
      Btn3: { onclick: () => inputDigit(3) },
      Btn4: { onclick: () => inputDigit(4) },
      Btn5: { onclick: () => inputDigit(5) },
      Btn6: { onclick: () => inputDigit(6) },
      Btn7: { onclick: () => inputDigit(7) },
      Btn8: { onclick: () => inputDigit(8) },
      Btn9: { onclick: () => inputDigit(9) },

      // Operation buttons
      AddBtn: { onclick: () => performOperation('+') },
      SubtractBtn: { onclick: () => performOperation('-') },
      MultiplyBtn: { onclick: () => performOperation('*') },
      DivideBtn: { onclick: () => performOperation('/') },
      EqualsBtn: { onclick: handleEquals },

      // Utility buttons
      DecimalBtn: { onclick: inputDecimal },
      ClearBtn: { onclick: clear },
      PlusMinusBtn: { onclick: toggleSign },
      PercentBtn: { onclick: percentage }
    }))
  </script>
</body>

</html>